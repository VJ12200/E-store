<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - E-Store</title>
    
    <!-- Material Design Lite CSS -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="stylesheets/mdl-custom.css">
    
    <style>
        .admin-container {
            background: #fafafa;
            min-height: 100vh;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .admin-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .admin-nav {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .admin-nav .mdl-tabs__tab-bar {
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .admin-nav .mdl-tabs__tab {
            color: #666;
        }
        
        .admin-nav .mdl-tabs__tab.is-active {
            color: #d32f2f;
        }
        
        .admin-section {
            display: none;
            padding: 20px;
        }
        
        .admin-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 2rem;
        }
        
        .stat-card p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .data-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table th {
            background: #f5f5f5;
            font-weight: 500;
            color: #333;
        }
        
        .data-table tr:hover {
            background: #f9f9f9;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-buttons .mdl-button {
            min-width: 60px;
            padding: 0 8px;
        }
        
        .search-bar {
            margin-bottom: 20px;
        }
        
        .search-bar .mdl-textfield {
            width: 100%;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            min-width: 40px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: 4px;
            margin: 16px 0;
            border-left: 4px solid #f44336;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 16px;
            border-radius: 4px;
            margin: 16px 0;
            border-left: 4px solid #4caf50;
        }
        
        /* Ensure Delete button text is black */
        .action-buttons .mdl-button--accent {
            color: #000 !important;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
            <div class="mdl-grid">
                <div class="mdl-cell mdl-cell--12-col">
                    <h1 style="margin: 0; font-size: 2rem; font-weight: 300;">
                        Admin Dashboard
                    </h1>
                    <p style="margin: 8px 0 0 0; opacity: 0.9;">
                        Manage products, reviews, and system settings
                    </p>
                </div>
            </div>
        </div>

        <!-- Admin Content -->
        <div class="admin-content">
            <!-- Navigation Tabs -->
            <div class="admin-nav">
                <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
                    <div class="mdl-tabs__tab-bar">
                        <a href="#products-panel" class="mdl-tabs__tab is-active">Products</a>
                        <a href="#reviews-panel" class="mdl-tabs__tab">Reviews</a>
                        <a href="#orders-panel" class="mdl-tabs__tab">Orders</a>
                        <a href="#stats-panel" class="mdl-tabs__tab">Statistics</a>
                    </div>
                </div>
            </div>

            <!-- Products Panel -->
            <div id="products-panel" class="admin-section active">
                <div class="search-bar">
                    <div class="mdl-textfield mdl-js-textfield">
                        <input class="mdl-textfield__input" type="text" id="productSearch" placeholder="Search products...">
                        <label class="mdl-textfield__label" for="productSearch">Search products</label>
                    </div>
                </div>
                <div style="margin-bottom: 12px;">
                    <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="addProductBtn">
                        Add Product
                    </button>
                </div>
                
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Category</th>
                                <th>Rating</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="7" class="loading">Loading products...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="productsPagination">
                    <!-- Pagination will be generated here -->
                </div>
            </div>

            <!-- Reviews Panel -->
            <div id="reviews-panel" class="admin-section">
                <div class="search-bar">
                    <div class="mdl-textfield mdl-js-textfield">
                        <input class="mdl-textfield__input" type="text" id="reviewSearch" placeholder="Search reviews...">
                        <label class="mdl-textfield__label" for="reviewSearch">Search reviews</label>
                    </div>
                </div>
                
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Product</th>
                                <th>User</th>
                                <th>Rating</th>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reviewsTableBody">
                            <tr>
                                <td colspan="7" class="loading">Loading reviews...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="reviewsPagination">
                    <!-- Pagination will be generated here -->
                </div>
            </div>

            <!-- Statistics Panel -->
            <div id="stats-panel" class="admin-section">
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">Loading statistics...</div>
                </div>
            </div>

            <!-- Orders Panel -->
            <div id="orders-panel" class="admin-section">
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User ID</th>
                                <th>Total</th>
                                <th>Created</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="5" class="loading">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Product</h2>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="editProductName" required>
                    <label class="mdl-textfield__label" for="editProductName">Product Name</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="number" id="editProductPrice" step="0.01" required>
                    <label class="mdl-textfield__label" for="editProductPrice">Price</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="number" id="editProductStock" required>
                    <label class="mdl-textfield__label" for="editProductStock">Stock</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="editProductCategory" required>
                    <label class="mdl-textfield__label" for="editProductCategory">Category</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <textarea class="mdl-textfield__input" id="editProductDescription" rows="3"></textarea>
                    <label class="mdl-textfield__label" for="editProductDescription">Description</label>
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                        Update Product
                    </button>
                    <button type="button" class="mdl-button mdl-js-button" onclick="closeModal('editProductModal')">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add Product</h2>
            <form id="addProductForm">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="addProductName" required>
                    <label class="mdl-textfield__label" for="addProductName">Product Name</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="number" id="addProductPrice" step="0.01" required>
                    <label class="mdl-textfield__label" for="addProductPrice">Price</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="number" id="addProductStock" value="0" required>
                    <label class="mdl-textfield__label" for="addProductStock">Stock</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="addProductCategory" required>
                    <label class="mdl-textfield__label" for="addProductCategory">Category</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <textarea class="mdl-textfield__input" id="addProductDescription" rows="3" required></textarea>
                    <label class="mdl-textfield__label" for="addProductDescription">Description</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="addProductImages">
                    <label class="mdl-textfield__label" for="addProductImages">Images (URL or JSON)</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="number" id="addProductSellerId" required>
                    <label class="mdl-textfield__label" for="addProductSellerId">Seller ID</label>
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                        Create Product
                    </button>
                    <button type="button" class="mdl-button mdl-js-button" onclick="closeModal('addProductModal')">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Messages -->
    <div id="messageContainer"></div>

    <!-- Material Design Lite JavaScript -->
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    
    <script>
        // Global variables
        let currentPage = 1;
        let currentSection = 'products';
        let products = [];
        let reviews = [];
        let orders = [];
        let currentUser = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            setupEventListeners();
            loadProducts();
        });

        // Check if user is admin
        async function checkAdminAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    window.location.href = '/login.html?redirect=admin';
                    return;
                }
                
                const data = await response.json();
                currentUser = data.user;
                if (data.user.role !== 'admin') {
                    showMessage('Access denied. Admin privileges required.', 'error');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html?redirect=admin';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.mdl-tabs__tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    const href = this.getAttribute('href') || '';
                    const section = href.replace('#', '').replace('-panel', '');
                    if (section) {
                        switchTab(section);
                    }
                });
            });

            // Search functionality
            document.getElementById('productSearch').addEventListener('input', debounce(loadProducts, 500));
            document.getElementById('reviewSearch').addEventListener('input', debounce(loadReviews, 500));

            // Modal close
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            // Add product open
            const addBtn = document.getElementById('addProductBtn');
            if (addBtn) {
                addBtn.addEventListener('click', function() {
                    // Reset form
                    document.getElementById('addProductForm').reset();
                    // Prefill seller ID with current user if available
                    if (currentUser && currentUser.id) {
                        document.getElementById('addProductSellerId').value = currentUser.id;
                    }
                    document.getElementById('addProductModal').style.display = 'block';
                });
            }

            // Edit product form
            document.getElementById('editProductForm').addEventListener('submit', updateProduct);

            // Add product form submit
            document.getElementById('addProductForm').addEventListener('submit', createProduct);
        }

        // Switch between tabs
        function switchTab(section) {
            // Update active tab
            document.querySelectorAll('.mdl-tabs__tab').forEach(tab => {
                tab.classList.remove('is-active');
            });
            document.querySelector(`[href="#${section}-panel"]`).classList.add('is-active');

            // Update active section
            document.querySelectorAll('.admin-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(`${section}-panel`).classList.add('active');

            currentSection = section;

            // Load data for the section
            if (section === 'products') {
                loadProducts();
            } else if (section === 'reviews') {
                loadReviews();
            } else if (section === 'orders') {
                loadOrders();
            } else if (section === 'stats') {
                loadStats();
            }
        }

        // Load products
        async function loadProducts() {
            try {
                const search = document.getElementById('productSearch').value;
                // Prevent cached 304 responses by adding a cache-buster and disabling cache
                const url = `/api/admin/products?page=${currentPage}&search=${encodeURIComponent(search)}&_=${Date.now()}`;
                const response = await fetch(url, {
                    credentials: 'include',
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load products');
                }
                
                const data = await response.json();
                products = data.products;
                displayProducts();
                updatePagination(data.pagination, 'products');
                
            } catch (error) {
                console.error('Error loading products:', error);
                showMessage('Failed to load products', 'error');
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch('/api/admin/orders', { credentials: 'include', cache: 'no-store' });
                if (!response.ok) throw new Error('Failed to load orders');
                const data = await response.json();
                orders = data.orders || [];
                displayOrdersAdmin();
            } catch (error) {
                console.error('Error loading orders:', error);
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="error">Failed to load orders</td></tr>';
            }
        }

        function displayOrdersAdmin() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            if (!orders.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">No orders found</td></tr>';
                return;
            }
            orders.forEach(o => {
                const tr = document.createElement('tr');
                const uiStatus = mapDbStatusToUi(o.status);
                tr.innerHTML = `
                    <td>${o.id}</td>
                    <td>${o.user_id}</td>
                    <td>$${Number(o.total).toFixed(2)}</td>
                    <td>${new Date(o.created_at).toLocaleString()}</td>
                    <td>
                        <select data-id="${o.id}" class="status-select">
                            ${renderStatusOption('processing', uiStatus)}
                            ${renderStatusOption('in_transit', uiStatus)}
                            ${renderStatusOption('out_for_delivery', uiStatus)}
                            ${renderStatusOption('delivered', uiStatus)}
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            // attach change listeners
            tbody.querySelectorAll('select.status-select').forEach(sel => {
                sel.addEventListener('change', async (e) => {
                    const id = e.target.getAttribute('data-id');
                    const status = e.target.value;
                    try {
                        const resp = await fetch(`/api/admin/orders/${encodeURIComponent(id)}/status`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ status })
                        });
                        if (!resp.ok) throw new Error('Failed to update status');
                        showMessage('Order status updated', 'success');
                        loadOrders();
                    } catch (err) {
                        showMessage('Failed to update status', 'error');
                    }
                });
            });
        }

        function renderStatusOption(value, current) {
            const labelMap = {
                processing: 'Processing',
                in_transit: 'In Transit',
                out_for_delivery: 'Out for Delivery',
                delivered: 'Delivered'
            };
            const selected = value === current ? 'selected' : '';
            return `<option value="${value}" ${selected}>${labelMap[value]}</option>`;
        }

        // Temporary mapping for databases still using old enum values
        function mapDbStatusToUi(status) {
            if (status === 'pending') return 'processing';
            if (status === 'shipped') return 'in_transit';
            return status;
        }

        // Display products in table
        function displayProducts() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No products found</td></tr>';
                return;
            }

            products.forEach(product => {
                const row = document.createElement('tr');
                // Safely format ratings that may come as strings from MySQL DECIMAL
                const ratingNumber = Number(product.ratings);
                const ratingText = Number.isFinite(ratingNumber) ? ratingNumber.toFixed(1) : 'N/A';

                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>$${product.price}</td>
                    <td>${product.stock}</td>
                    <td>${product.category}</td>
                    <td>${ratingText}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="mdl-button mdl-js-button mdl-button--primary" onclick="editProduct(${product.id})">
                                Edit
                            </button>
                            <button class="mdl-button mdl-js-button mdl-button--accent" onclick="deleteProduct(${product.id})">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load reviews
        async function loadReviews() {
            try {
                const search = document.getElementById('reviewSearch').value;
                const response = await fetch(`/api/admin/reviews?page=${currentPage}&search=${encodeURIComponent(search)}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load reviews');
                }
                
                const data = await response.json();
                reviews = data.reviews;
                displayReviews();
                updatePagination(data.pagination, 'reviews');
                
            } catch (error) {
                console.error('Error loading reviews:', error);
                showMessage('Failed to load reviews', 'error');
            }
        }

        // Display reviews in table
        function displayReviews() {
            const tbody = document.getElementById('reviewsTableBody');
            tbody.innerHTML = '';

            if (reviews.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No reviews found</td></tr>';
                return;
            }

            reviews.forEach(review => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${review.id}</td>
                    <td>${review.product_name}</td>
                    <td>${review.user_name}</td>
                    <td>${review.rating} stars</td>
                    <td>${review.title}</td>
                    <td>${new Date(review.created_at).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="mdl-button mdl-js-button mdl-button--accent" onclick="deleteReview(${review.id})">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load statistics (Category Stats)
        async function loadStats() {
            try {
                const res = await fetch('/api/analytics/categories', { credentials: 'include', cache: 'no-store' });
                if (!res.ok) throw new Error('Failed to load category stats');
                const json = await res.json();
                const categories = (json.data || json) || [];
                displayCategoryStats(categories);
            } catch (error) {
                console.error('Error loading stats:', error);
                showMessage('Failed to load category statistics', 'error');
            }
        }

        // Display category statistics in table form
        function displayCategoryStats(categories) {
            const statsGrid = document.getElementById('statsGrid');
            const rowsHtml = categories.map(row => {
                const avgPrice = row.avg_price != null ? Number(row.avg_price).toFixed(2) : '0.00';
                const avgRating = row.avg_rating != null ? Number(row.avg_rating).toFixed(1) : '0.0';
                return `
                    <tr>
                      <td>${row.category || 'Uncategorized'}</td>
                      <td>${row.product_count ?? 0}</td>
                      <td>$${avgPrice}</td>
                      <td>${avgRating}</td>
                      <td>${row.total_stock ?? 0}</td>
                    </tr>
                `;
            }).join('');

            statsGrid.innerHTML = `
              <div class="data-table">
                <table>
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th>Products</th>
                      <th>Avg. Price</th>
                      <th>Avg. Rating</th>
                      <th>Total Stock</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${rowsHtml || '<tr><td colspan="5" class="loading">No category stats found</td></tr>'}
                  </tbody>
                </table>
              </div>
            `;
        }

        // Edit product
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductStock').value = product.stock;
            document.getElementById('editProductCategory').value = product.category;
            document.getElementById('editProductDescription').value = product.description || '';

            document.getElementById('editProductModal').style.display = 'block';
        }

        // Update product
        async function updateProduct(e) {
            e.preventDefault();
            
            const productId = document.getElementById('editProductId').value;
            const formData = {
                name: document.getElementById('editProductName').value,
                price: parseFloat(document.getElementById('editProductPrice').value),
                stock: parseInt(document.getElementById('editProductStock').value),
                category: document.getElementById('editProductCategory').value,
                description: document.getElementById('editProductDescription').value
            };

            try {
                const response = await fetch(`/api/admin/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('Failed to update product');
                }

                showMessage('Product updated successfully', 'success');
                closeModal('editProductModal');
                loadProducts();

            } catch (error) {
                console.error('Error updating product:', error);
                showMessage('Failed to update product', 'error');
            }
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/products/${productId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete product');
                }

                showMessage('Product deleted successfully', 'success');
                loadProducts();

            } catch (error) {
                console.error('Error deleting product:', error);
                showMessage('Failed to delete product', 'error');
            }
        }

        // Create product
        async function createProduct(e) {
            e.preventDefault();

            const payload = {
                name: document.getElementById('addProductName').value,
                price: parseFloat(document.getElementById('addProductPrice').value),
                stock: parseInt(document.getElementById('addProductStock').value),
                category: document.getElementById('addProductCategory').value,
                description: document.getElementById('addProductDescription').value,
                images: document.getElementById('addProductImages').value || '',
                sellerId: parseInt(document.getElementById('addProductSellerId').value)
            };

            // Basic validation
            if (!payload.name || !payload.description || !payload.category || !Number.isFinite(payload.price) || !Number.isInteger(payload.sellerId)) {
                showMessage('Please fill all required fields with valid values', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.message || 'Failed to create product');
                }

                showMessage('Product created successfully', 'success');
                closeModal('addProductModal');
                loadProducts();

            } catch (error) {
                console.error('Error creating product:', error);
                showMessage('Failed to create product', 'error');
            }
        }

        // Delete review
        async function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/reviews/${reviewId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete review');
                }

                showMessage('Review deleted successfully', 'success');
                loadReviews();

            } catch (error) {
                console.error('Error deleting review:', error);
                showMessage('Failed to delete review', 'error');
            }
        }

        // Update pagination
        function updatePagination(pagination, type) {
            const paginationContainer = document.getElementById(`${type}Pagination`);
            paginationContainer.innerHTML = '';

            if (pagination.totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'mdl-button mdl-js-button';
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = pagination.currentPage === 1;
            prevBtn.onclick = () => {
                currentPage = pagination.currentPage - 1;
                if (type === 'products') loadProducts();
                else if (type === 'reviews') loadReviews();
            };
            paginationContainer.appendChild(prevBtn);

            // Page numbers
            for (let i = 1; i <= pagination.totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `mdl-button mdl-js-button ${i === pagination.currentPage ? 'mdl-button--colored' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentPage = i;
                    if (type === 'products') loadProducts();
                    else if (type === 'reviews') loadReviews();
                };
                paginationContainer.appendChild(pageBtn);
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'mdl-button mdl-js-button';
            nextBtn.textContent = 'Next';
            nextBtn.disabled = pagination.currentPage === pagination.totalPages;
            nextBtn.onclick = () => {
                currentPage = pagination.currentPage + 1;
                if (type === 'products') loadProducts();
                else if (type === 'reviews') loadReviews();
            };
            paginationContainer.appendChild(nextBtn);
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Show message
        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageContainer.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
